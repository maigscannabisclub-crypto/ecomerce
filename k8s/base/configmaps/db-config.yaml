---
# ConfigMap de configuración de base de datos
apiVersion: v1
kind: ConfigMap
metadata:
  name: db-config
  namespace: ecommerce-data
  labels:
    app.kubernetes.io/name: db-config
    app.kubernetes.io/component: database-configuration
data:
  # Configuración de PostgreSQL
  POSTGRES_PORT: "5432"
  POSTGRES_DB: "ecommerce"
  POSTGRES_MAX_CONNECTIONS: "200"
  POSTGRES_SHARED_BUFFERS: "256MB"
  POSTGRES_EFFECTIVE_CACHE_SIZE: "768MB"
  POSTGRES_WORK_MEM: "4MB"
  POSTGRES_MAINTENANCE_WORK_MEM: "64MB"
  
  # Configuración de pg_hba.conf
  POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=en_US.UTF-8"
  
  # Configuración de Redis
  REDIS_PORT: "6379"
  REDIS_MAXMEMORY: "512mb"
  REDIS_MAXMEMORY_POLICY: "allkeys-lru"
  REDIS_TIMEOUT: "300"
  REDIS_TCP_KEEPALIVE: "60"
  REDIS_LOG_LEVEL: "notice"
  
  # Configuración de RabbitMQ
  RABBITMQ_DEFAULT_VHOST: "/"
  RABBITMQ_HIPE_COMPILE: "false"
  RABBITMQ_VM_MEMORY_HIGH_WATERMARK: "0.6"
  RABBITMQ_DISK_FREE_LIMIT: "1GB"
  RABBITMQ_MANAGEMENT_ENABLED: "true"
  RABBITMQ_PLUGINS: "rabbitmq_management,rabbitmq_prometheus"
  
  # Configuración de backup
  BACKUP_SCHEDULE: "0 2 * * *"
  BACKUP_RETENTION_DAYS: "7"
  
  # Scripts de inicialización
  init-auth-db.sql: |
    CREATE DATABASE IF NOT EXISTS auth_db;
    \c auth_db;
    CREATE TABLE IF NOT EXISTS users (
      id SERIAL PRIMARY KEY,
      email VARCHAR(255) UNIQUE NOT NULL,
      password_hash VARCHAR(255) NOT NULL,
      first_name VARCHAR(100),
      last_name VARCHAR(100),
      role VARCHAR(50) DEFAULT 'customer',
      is_active BOOLEAN DEFAULT true,
      email_verified BOOLEAN DEFAULT false,
      created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
      updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    );
    CREATE INDEX IF NOT EXISTS idx_users_email ON users(email);
    CREATE INDEX IF NOT EXISTS idx_users_role ON users(role);
  
  init-product-db.sql: |
    CREATE DATABASE IF NOT EXISTS product_db;
    \c product_db;
    CREATE TABLE IF NOT EXISTS products (
      id SERIAL PRIMARY KEY,
      sku VARCHAR(100) UNIQUE NOT NULL,
      name VARCHAR(255) NOT NULL,
      description TEXT,
      price DECIMAL(10,2) NOT NULL,
      category_id INTEGER,
      brand VARCHAR(100),
      weight DECIMAL(8,2),
      is_active BOOLEAN DEFAULT true,
      created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
      updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    );
    CREATE INDEX IF NOT EXISTS idx_products_sku ON products(sku);
    CREATE INDEX IF NOT EXISTS idx_products_category ON products(category_id);
    CREATE INDEX IF NOT EXISTS idx_products_active ON products(is_active);
  
  init-order-db.sql: |
    CREATE DATABASE IF NOT EXISTS order_db;
    \c order_db;
    CREATE TABLE IF NOT EXISTS orders (
      id SERIAL PRIMARY KEY,
      order_number VARCHAR(50) UNIQUE NOT NULL,
      user_id INTEGER NOT NULL,
      status VARCHAR(50) DEFAULT 'pending',
      total_amount DECIMAL(10,2) NOT NULL,
      currency VARCHAR(3) DEFAULT 'USD',
      shipping_address JSONB,
      billing_address JSONB,
      created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
      updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    );
    CREATE INDEX IF NOT EXISTS idx_orders_user ON orders(user_id);
    CREATE INDEX IF NOT EXISTS idx_orders_status ON orders(status);
    CREATE INDEX IF NOT EXISTS idx_orders_created ON orders(created_at);
